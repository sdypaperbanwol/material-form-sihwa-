<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìì¬ ì‹ ì²­</title>
  <style>
    body { font-family: 'sans-serif'; background:#f7f7f7; text-align:center; padding:1rem; margin:0; }
    .hidden { display:none!important; }
    .step { margin-top:1.5rem; }
    .button-list { display:flex; flex-direction:column; align-items:center; gap:0.5rem; margin-bottom:2rem; }
    button { padding:0.6rem 1.2rem; font-size:1rem; border-radius:6px; border:none; background:#ddd; cursor:pointer; width:70%; max-width:300px; }
    button:hover { background:#4CAF50!important; color:white; }
    .selected { background:#4CAF50!important; color:white; font-weight:bold; }
    button:disabled { background:#ccc; color:#777; cursor:not-allowed; }
    .has-stock { background:#c8e6c9!important; color:#1b5e20!important; font-weight:bold; }
    .no-stock { background:#eeeeee!important; color:#777!important; }
    #quantity-display { font-size:2rem; margin-bottom:1rem; font-weight:bold; }
    #record-buttons:not(.hidden) { display:flex; justify-content:center; gap:0.8rem; margin:0.5rem 0 1rem 0; flex-wrap:wrap; }

    /* ì˜¤ë²„ë ˆì´ (ê³µí†µ) */
    #submitOverlay, #loadingOverlay, #initialLoadingOverlay {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      display: none; justify-content: center; align-items: center;
      z-index: 9999;
      color: white; font-size: 1.4rem;
    }
    #submitOverlay { z-index: 10050; }
    #initialLoadingOverlay { display:flex; }
    #submitOverlay span {
      background:white; padding:20px 40px; border-radius:12px; font-size:1.3rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.3); color:#000;
    }

    .list-preview-container { max-height:300px; overflow-y:auto; background:#f9f9f9; padding:1rem; border-radius:10px; font-size:0.95rem; }
    .list-item-row { display:flex; justify-content:space-between; align-items:center; padding:0.4rem 0; border-bottom:1px solid #e0e0e0; }
    .list-item-text { flex:1; text-align:left; word-break:break-word; padding-right:0.5rem; }
    .delete-btn { font-size:0.8rem; background:transparent; border:none; color:#888; cursor:pointer; width:22px; height:22px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:background 0.2s; padding:0; box-sizing:border-box; }
    .delete-btn:hover { background:#ffe5e5; color:#d00; }
    .button-row { display:flex; justify-content:center; gap:1rem; margin:1rem auto; flex-wrap:wrap; }
    .half-btn { flex:1 1 30%; max-width:180px; min-width:140px; padding:0.6rem 0.8rem; font-size:1rem; border:none; border-radius:8px; background:#ddd; cursor:pointer; }
    .half-btn:hover { background:#4CAF50; color:#fff; }
    .numpad-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:0.6rem; margin:1rem auto; width:fit-content; }
    .numpad-grid button { padding:1rem; font-size:1.5rem; border-radius:10px; background:#e0e0e0; border:none; cursor:pointer; transition:background .2s; }
    .numpad-grid button:hover { background:#ccc; }

    /* ë¡œê·¸ì¸ì°½ */
    #login-section { display:block; }
    #login-section input {
      padding:1.00rem; font-size:1.05rem; margin:0.8rem auto;
      width:80%; max-width:300px; display:block; border-radius:6px; border:1px solid #ccc;
    }
    #login-section button {
      padding:1.0rem 1.2rem; font-size:1.05rem; margin-top:1rem;
      border-radius:8px; background-color:#4CAF50; color:white; border:none; cursor:pointer;
      width:80%; max-width:300px;
    }
  </style>
</head>
<body>
<div id="initialLoadingOverlay">â³ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</div>

<h2 id="title">ğŸ” ì‹ ì²­Â·ì¡°ì‚¬ ì‹œìŠ¤í…œ</h2>

<div id="record-buttons" class="hidden">
  <button onclick="openMyRecords()" style="font-size:0.9rem;font-weight:bold;background:#fff;color:#007bff;border:1px solid #007bff;border-radius:6px;padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 1px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='#fff'">ğŸ“„ ë‚´ ì‹ ì²­ ë‚´ì—­</button>
  <button onclick="openTeamRecords()" style="font-size:0.9rem;font-weight:bold;background:#fff;color:#28a745;border:1px solid #28a745;border-radius:6px;padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 1px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#eaffea'" onmouseout="this.style.background='#fff'">ğŸ‘¥ íŒ€ ì‹ ì²­ ë‚´ì—­</button>
</div>

<!-- ë¡œê·¸ì¸ -->
<div id="login-section">
  <div id="inlineNoticeBox" style="background:#fff3cd;border:1px solid #ffeeba;padding:10px;margin:10px 0;border-radius:6px;color:#856404;font-size:0.9rem;display:none;white-space:pre-wrap;"></div>
  <p>ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
  <input id="empId" placeholder="ì‚¬ë²ˆ" />
  <input id="empName" placeholder="ì´ë¦„" />
  <button onclick="handleLogin()">ë¡œê·¸ì¸</button>
  <div id="loginMsg"></div>
  <div id="loginLoadingText" class="hidden">ğŸ” ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>

<!-- ì‹ ì²­ í¼ -->
<div id="form-section" class="hidden">
  <!-- 1ë‹¨ê³„ -->
  <div id="step-category" class="step">
    <h3>1ë‹¨ê³„: ëŒ€ë¶„ë¥˜ ì„ íƒ</h3>
    <div id="category-buttons" class="button-list"></div>
  </div>

  <!-- ì‚¬ì§„ ëª¨ë‹¬ -->
  <div id="photoModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:999;overflow:auto;">
    <div style="background:white;margin:40px auto;padding:20px;border-radius:10px;max-width:600px;">
      <span id="closeModal" style="position:fixed;top:20px;right:20px;font-size:28px;cursor:pointer;z-index:1000;background:white;padding:4px 10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">âœ–</span>
      <div id="photoContent"></div>
    </div>
  </div>

  <!-- 2ë‹¨ê³„ -->
  <div id="step-type" class="step hidden">
    <h3>2ë‹¨ê³„: ì¤‘ë¶„ë¥˜ ì„ íƒ</h3>
    <div id="type-buttons" class="button-list"></div>
    <button type="button" id="viewPhotosType" style="background:#007bff;color:white;padding:10px;border:none;border-radius:6px;cursor:pointer;margin-top:6px;">í•­ëª© ì‚¬ì§„ ë³´ê¸°</button>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('category')">â¬… ë’¤ë¡œê°€ê¸°</button></div>
  </div>

  <!-- 3ë‹¨ê³„ -->
  <div id="step-size" class="step hidden">
    <h3>3ë‹¨ê³„: ì†Œë¶„ë¥˜ ì„ íƒ</h3>
    <p style="font-size:0.85rem;color:#666;margin:0.5rem 0;">âš ï¸ ì¬ê³ ê°€ ì—†ë”ë¼ë„ ì„ íƒ í›„ ì‹ ì²­í•˜ì‹œë©´ êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
    <div id="size-buttons" class="button-list"></div>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('type')">â¬… ë’¤ë¡œê°€ê¸°</button></div>
  </div>

  <!-- 4ë‹¨ê³„ -->
  <div id="step-quantity" class="step hidden">
    <h3>4ë‹¨ê³„: ìˆ˜ëŸ‰ ì…ë ¥</h3>
    <div class="numpad-container" style="margin:0 auto;">
      <div id="quantity-display">0</div>
      <div id="numpad" class="numpad-grid">
        <button onclick="appendQuantity('1')">1</button><button onclick="appendQuantity('2')">2</button><button onclick="appendQuantity('3')">3</button>
        <button onclick="appendQuantity('4')">4</button><button onclick="appendQuantity('5')">5</button><button onclick="appendQuantity('6')">6</button>
        <button onclick="appendQuantity('7')">7</button><button onclick="appendQuantity('8')">8</button><button onclick="appendQuantity('9')">9</button>
        <button onclick="clearQuantity()">C</button><button onclick="appendQuantity('0')">0</button><button onclick="backspaceQuantity()">â†</button>
      </div>
    </div>

    <textarea id="remarks" placeholder="ë¹„ê³  (ìš”ì²­ì‚¬í•­)" rows="2" style="width:100%;max-width:400px;margin:1.5rem auto 1rem auto;padding:0.6rem;font-size:1rem;border-radius:6px;border:1px solid #ccc;display:block;resize:none;"></textarea>

    <div class="button-row"><button class="half-btn" onclick="addItemToList()">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button></div>

    <div class="list-preview-container" style="margin:0 auto;text-align:center;">
      <ul id="itemListPreview" style="display:inline-block;text-align:left;font-size:0.9rem;"></ul>
    </div>

    <p style="font-size:0.9rem;color:#666;margin-top:0.5rem;">ğŸ› ë‹´ì€ í•­ëª©ì„ í™•ì¸í•˜ì…¨ë‹¤ë©´ <b>ì „ì²´ ì‹ ì²­í•˜ê¸°</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>

    <div class="button-row"><button class="half-btn" onclick="submitAllRequests()">âœ… ì „ì²´ ì‹ ì²­í•˜ê¸°</button></div>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('category')">ğŸ“¦ ë‹¤ë¥¸ ë¬¼í’ˆ ì¶”ê°€</button></div>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('size')">â¬… ë’¤ë¡œê°€ê¸°</button></div>
  </div>

  <!-- ë‚´ì—­ ëª¨ë‹¬ -->
  <div id="myRecordsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
    <button onclick="closeMyRecords()" style="position:fixed;top:20px;right:20px;font-size:22px;font-weight:bold;border:none;background:none;cursor:pointer;color:white;z-index:10000;">âœ–</button>
    <div style="position:relative;margin:60px auto 0;background:white;padding:20px 24px 30px;border-radius:10px;max-width:800px;width:95%;max-height:80vh;overflow:auto;">
      <h3 style="margin-top:0;margin-bottom:15px;">ğŸ“„ ì‹ ì²­ ë‚´ì—­</h3>
      <table id="myRecordsTable" style="width:100%;font-size:14px;border-collapse:collapse;">
        <thead><tr></tr></thead><tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const endpoint = 'https://script.google.com/macros/s/AKfycby8VMInBKCZDcpT2wg7h5lgsHdfqnSymRg4CKa3Kr4oQ4gEEuzd0g5jkq-5Q1Z6_ILPNg/exec';

  let loginInfo = { empId: '', empName: '' };
  let itemData = {};
  let zMeta = {};
  let itemList = [];
  let selected = { category: '', type: '', size: '', zcode: '' };
  let quantityValue = "";

  /* ê³µì§€ ë Œë” ìœ í‹¸ */
  function renderNoticeTo(el, text) {
    if (!el) return;
    const safe = String(text || '').replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))
                                   .replace(/\n/g, '<br/>');
    el.innerHTML = safe;
  }

  // ë¡œê·¸ì¸
  function handleLogin() {
    const empId = document.getElementById('empId').value.trim();
    const empName = document.getElementById('empName').value.trim();
    if (!empId || !empName) return alert("ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    document.getElementById('loginLoadingText').classList.remove('hidden');
    document.querySelector('#login-section button').style.display = 'none';

    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ empId, empName })
    })
    .then(res => res.json())
    .then(async data => {
      document.getElementById('loginLoadingText').classList.add('hidden');
      if (data.result === 'success') {
        loginInfo = { empId, empName };
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('form-section').classList.remove('hidden');
        document.getElementById('title').innerText = "ğŸ” ì‹ ì²­Â·ì¡°ì‚¬ ì‹œìŠ¤í…œ";
        document.getElementById('record-buttons').classList.remove('hidden');
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
          zMeta = (await fetch(`${endpoint}?mode=zinfo`).then(r => r.json())) || {};
        } catch (e) {
          console.warn('zinfo ë¡œë“œ ì‹¤íŒ¨', e);
        }
        loadItems();
      } else {
        document.getElementById('loginMsg').innerText = 'ë¡œê·¸ì¸ ì‹¤íŒ¨ ë˜ëŠ” ê¶Œí•œ ì—†ìŒ';
        document.querySelector('#login-section button').style.display = 'inline-block';
      }
    })
    .catch(error => {
      document.getElementById('loginLoadingText').classList.add('hidden');
      document.getElementById('loginMsg').innerText = 'ì„œë²„ ì˜¤ë¥˜: ' + error.message;
      document.querySelector('#login-section button').style.display = 'block';
    });
  }

  // ëª©ë¡ ë¡œë“œ
  function loadItems() {
    fetch(endpoint)
      .then(res => res.json())
      .then(data => {
        itemData = data;
        const container = document.getElementById('category-buttons');
        container.innerHTML = '';
        Object.keys(data).forEach(cat => {
          const btn = document.createElement('button');
          const activationCode = data[cat].activation; // Y/Z1/Z2/Z3

          if (activationCode && activationCode.startsWith('Z')) {
            const code = activationCode.toUpperCase();
            const titleFromMeta = zMeta?.[code]?.title;
            btn.innerText = titleFromMeta || cat;
            btn.style.backgroundColor = "#fff9c4";
            btn.style.color = "#f57f17";
            btn.style.fontWeight = "bold";
            btn.style.border = "1px solid #fbc02d";
          } else {
            btn.innerText = cat;
          }

          btn.onclick = () => {
            selected.category = cat;
            selected.zcode = activationCode || '';
            if (activationCode === "Z2") openZ2UniformModal();
            else if (activationCode === "Z1" || activationCode === "Z3") openZ1Modal();
            else { updateSelection(container, btn); selectCategory(cat); }
          };

          container.appendChild(btn);
        });
        document.getElementById('loadingOverlay').style.display = 'none';
      })
      .catch(error => {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert('âŒ í•­ëª© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
      });
  }

  // ë‹¨ê³„ ì´ë™
  function selectCategory(cat) {
    const types = itemData[cat].types;
    const container = document.getElementById('type-buttons');
    container.innerHTML = '';
    types.forEach(type => {
      const btn = document.createElement('button');
      btn.innerText = type;
      btn.onclick = () => { selected.type = type; updateSelection(container, btn); selectType(type); };
      container.appendChild(btn);
    });
    showStep('type');
  }
  function selectType(type) {
    const container = document.getElementById('size-buttons');
    container.innerHTML = '';
    const stockMap = itemData[selected.category].stockMap;
    const sizeKeys = Object.keys(stockMap).filter(k => k.startsWith(type + '__'));
    sizeKeys.forEach(k => {
      const size = k.split('__')[1];
      const stock = stockMap[k];
      const btn = document.createElement('button');
      btn.innerText = `${size} (ì¬ê³ : ${stock})`;
      if (stock > 0) btn.classList.add('has-stock'); else btn.classList.add('no-stock');
      btn.onclick = () => { selected.size = size; updateSelection(container, btn); selectSize(size); };
      container.appendChild(btn);
    });
    showStep('size');
  }
  function selectSize() { showStep('quantity'); }
  function showStep(step) {
    ['category','type','size','quantity'].forEach(s => document.getElementById('step-'+s).classList.add('hidden'));
    document.getElementById('step-'+step).classList.remove('hidden');
    const rb = document.getElementById('record-buttons');
    if (step === 'category') rb.classList.remove('hidden'); else rb.classList.add('hidden');
  }
  function goBackTo(step) { showStep(step); }

  // ì¥ë°”êµ¬ë‹ˆ / ì¼ê´„ ì‹ ì²­ (ì¼ë°˜í’ˆëª©)
  function addItemToList() {
    const quantity = quantityValue;
    const remarks = document.getElementById('remarks').value;
    if (!quantity || parseInt(quantity) <= 0) return alert("ì‹ ì²­ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const stockKey = `${selected.type}__${selected.size}`;
    const currentStock = parseInt(itemData[selected.category]?.stockMap?.[stockKey] || "0", 10);
    const requestedQty = parseInt(quantity, 10);
    const ì§€ê¸‰ìˆ˜ëŸ‰ = Math.min(requestedQty, currentStock);
    const êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ = Math.max(0, requestedQty - currentStock);

    if (êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ > 0) {
      if (currentStock > 0) alert(`âš ï¸ í˜„ì¬ ${currentStock}ê°œë§Œ ì§€ê¸‰ ê°€ëŠ¥í•˜ë©°, ë‚˜ë¨¸ì§€ ${êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰}ê°œëŠ” êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤.`);
      else alert(`âš ï¸ í˜„ì¬ ì¬ê³ ê°€ ì—†ì–´ ${êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰}ê°œ ì „ëŸ‰ êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤.`);
    }

    const item = {
      name: `${loginInfo.empId} ${loginInfo.empName}`,
      category: selected.category,
      subcategory: selected.type,
      size: selected.size,
      quantity: requestedQty,
      remarks
    };

    itemList.push(item);
    renderItemList();
    quantityValue = ""; updateQuantityDisplay();
    document.getElementById('remarks').value = '';
  }

  function renderItemList() {
    const previewContainer = document.getElementById('itemListPreview');
    previewContainer.innerHTML = '';
    if (itemList.length === 0) {
      const empty = document.createElement('div');
      empty.innerText = "â• í•­ëª©ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
      empty.style.textAlign="center"; empty.style.color="#aaa"; empty.style.padding="1rem";
      previewContainer.appendChild(empty);
      return;
    }
    itemList.forEach((item, index) => {
      const row = document.createElement('div'); row.className = 'list-item-row';
      const text = document.createElement('div'); text.className = 'list-item-text';
      text.innerText = `${item.category} > ${item.subcategory} > ${item.size} - ${item.quantity}ê°œ` + (item.remarks ? ` (${item.remarks})` : '');
      const delBtn = document.createElement('button'); delBtn.className='delete-btn'; delBtn.innerText='âœ•';
      delBtn.onclick = () => { itemList.splice(index, 1); renderItemList(); };
      row.appendChild(text); row.appendChild(delBtn); previewContainer.appendChild(row);
    });
  }

  async function submitAllRequests() {
    if (itemList.length === 0) return alert("ì‹ ì²­ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
    document.getElementById('submitOverlay').style.display = 'flex';
    try {
      for (const item of itemList) {
        const stockKey = `${item.subcategory}__${item.size}`;
        const stockMap = itemData[item.category]?.stockMap || {};
        const currentStock = parseInt(stockMap[stockKey]) || 0;
        const quantity = parseInt(item.quantity);
        const ì§€ê¸‰ìˆ˜ëŸ‰ = Math.min(quantity, currentStock);
        const êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ = Math.max(quantity - currentStock, 0);

        const payload = {
          name: item.name,
          category: item.category,
          subcategory: item.subcategory,
          size: item.size,
          quantity,
          remarks: item.remarks,
          ì§€ê¸‰ìˆ˜ëŸ‰,
          êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰
        };

        await fetch(endpoint, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body:new URLSearchParams(payload)
        });
      }
      alert("âœ… ëª¨ë“  í•­ëª©ì´ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } catch (error) {
      alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + error.message);
    } finally {
      document.getElementById('submitOverlay').style.display = 'none';
    }
  }

  // ìˆ«ì í‚¤íŒ¨ë“œ
  function appendQuantity(num) { if (quantityValue.length < 4) { quantityValue += num; updateQuantityDisplay(); } }
  function clearQuantity() { quantityValue = ""; updateQuantityDisplay(); }
  function backspaceQuantity() { quantityValue = quantityValue.slice(0,-1); updateQuantityDisplay(); }
  function updateQuantityDisplay() { document.getElementById("quantity-display").innerText = quantityValue || "0"; }

  // ì‚¬ì§„ ëª¨ë‹¬
  document.getElementById("viewPhotosType").addEventListener("click", () => {
    const category = selected.category; if (!category) return alert("ë¨¼ì € ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    document.getElementById("loadingOverlay").style.display = "flex";
    fetch(`${endpoint}?mode=photo`)
      .then(res => res.json())
      .then(photoMap => {
        const urls = photoMap[category];
        const container = document.getElementById("photoContent"); container.innerHTML = "";
        if (!urls || urls.length === 0) {
          container.innerHTML = "<p>í•´ë‹¹ í•­ëª©ì˜ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        } else {
          urls.forEach(url => {
            const fileName = url.split("/").pop().split(".")[0];
            const wrapper = document.createElement("div");
            wrapper.style.marginBottom="20px";
            wrapper.innerHTML = `<div style="font-weight:bold;margin-bottom:5px;">${fileName}</div><img src="${url}" style="max-width:100%;border:1px solid #ccc;border-radius:8px;" />`;
            container.appendChild(wrapper);
          });
        }
        document.getElementById("photoModal").style.display = "block";
      })
      .catch(err => alert("âŒ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message))
      .finally(() => document.getElementById("loadingOverlay").style.display = "none");
  });
  document.getElementById("closeModal").addEventListener("click", () => { document.getElementById("photoModal").style.display = "none"; });

  // ê³µì§€ ë¡œë”©(ìƒë‹¨ ë°•ìŠ¤)
  document.addEventListener("DOMContentLoaded", () => {
    const box = document.getElementById("inlineNoticeBox");
    const loading = document.getElementById("initialLoadingOverlay");
    fetch(`${endpoint}?mode=notice`)
      .then(res => res.json())
      .then(data => {
        const notice = data.notice?.trim();
        if (notice) { box.textContent = notice; box.style.display = "block"; }
      })
      .catch(err => console.warn("ê³µì§€ì‚¬í•­ ë¡œë”© ì‹¤íŒ¨:", err))
      .finally(() => { loading.style.display = 'none'; });
  });

  // ë‚´ì—­ ë³´ê¸°
  function openMyRecords() {
    const empId = loginInfo.empId;
    document.getElementById('loadingOverlay').style.display = 'flex';
    fetch(`${endpoint}?mode=myrecords&empId=${encodeURIComponent(empId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.result !== "success") {
          document.getElementById('loadingOverlay').style.display = 'none';
          return alert("âŒ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        renderRecordsTable(data, [0, 2, 4, 5, 6, 9, 10, 8]);
      })
      .catch(err => {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
      })
      .finally(() => { document.getElementById('loadingOverlay').style.display = 'none'; });
  }
  function openTeamRecords() {
    const empId = loginInfo.empId;
    document.getElementById('loadingOverlay').style.display = 'flex';
    fetch(`${endpoint}?mode=teamrecords&empId=${encodeURIComponent(empId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.result === "forbidden") {
          document.getElementById('loadingOverlay').style.display = 'none';
          return alert("âš ï¸ íŒ€ ë‚´ì—­ ì¡°íšŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        }
        if (data.result !== "success") {
          document.getElementById('loadingOverlay').style.display = 'none';
          return alert("âŒ íŒ€ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        renderRecordsTable(data, [0, 2, 4, 5, 6, 9, 10]);
      })
      .catch(err => {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
      })
      .finally(() => { document.getElementById('loadingOverlay').style.display = 'none'; });
  }
  function renderRecordsTable(data, colIndexes) {
    const thead = document.querySelector("#myRecordsTable thead");
    const tbody = document.querySelector("#myRecordsTable tbody");
    thead.innerHTML = "<tr>" + colIndexes.map(i => `<th style="border:1px solid #ccc;background:#f0f0f0;padding:4px;text-align:center;">${data.header[i]}</th>`).join("") + "</tr>";
    tbody.innerHTML = data.records.map(row => "<tr>" + colIndexes.map(i => `<td style="border:1px solid #ccc;padding:6px;text-align:center;">${i===0?formatDate(row[i]):row[i]}</td>`).join("") + "</tr>").join("");
    document.getElementById("myRecordsModal").style.display = "flex";
  }
  function closeMyRecords() { document.getElementById("myRecordsModal").style.display = "none"; }
  function formatDate(raw) {
    const d = new Date(raw);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function updateSelection(container, selectedBtn) {
    Array.from(container.children).forEach(btn => btn.classList.remove('selected'));
    selectedBtn.classList.add('selected');
  }

  // Z1/Z3 ëª¨ë‹¬ â€” í—¤ë”/ê³µì§€ ë™ì  ë°˜ì˜, ìˆ˜ëŸ‰ ì œí•œ ì—†ìŒ
  function openZ1Modal() {
    const code = (selected.zcode || 'Z1').toUpperCase();
    const headerEl = document.getElementById('z1Header');
    const headerTxt = zMeta?.[code]?.header || 'ğŸ“… ì •ê¸° ì‹ ì²­ (Z1/Z3)';
    if (headerEl) headerEl.innerText = headerTxt;
    const notice = zMeta?.[code]?.notice || zMeta?.Z1?.notice || '';
    renderNoticeTo(document.getElementById('z1RuleText'), notice);

    const listContainer = document.getElementById("z1-item-list");
    listContainer.innerHTML = "";
    const stockMap = itemData[selected.category]?.stockMap || {};
    const names = Object.keys(stockMap).map(k => k.split("__")[0]).filter((v,i,self)=>self.indexOf(v)===i);
    if (names.length === 0) {
      listContainer.innerHTML = "<p>ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }

    names.forEach(name => {
      const row = document.createElement("div");
      row.style.display="flex";
      row.style.alignItems="center";
      row.style.justifyContent="space-between";
      row.style.marginBottom="10px";
      const inputId = `z1_qty_${name}`;
      row.innerHTML = `
        <div style="flex:1;">${name}</div>
        <input type="number" id="${inputId}" placeholder="ìˆ˜ëŸ‰" min="0" value="1"
               style="width:80px;text-align:center;border:1px solid #ccc;border-radius:6px;padding:4px;">
      `;
      listContainer.appendChild(row);
    });

    document.getElementById("modalZ1").style.display = "block";
  }
  function closeZ1Modal() { document.getElementById("modalZ1").style.display = "none"; }

  // â˜… Z1/Z3 ì¦‰ì‹œ ì „ì†¡ (ìˆ˜ëŸ‰ ì œí•œ ì—†ì´)
  async function submitZ1() {
    const remarks = document.getElementById("z1-remarks").value;
    const stockMap = itemData[selected.category]?.stockMap || {};
    const names = Object.keys(stockMap).map(k => k.split("__")[0]).filter((v,i,self)=>self.indexOf(v)===i);
    const itemsToSubmit = [];

    names.forEach(name => {
      const qtyInput = document.getElementById("z1_qty_" + name);
      const qty = parseInt(qtyInput?.value || "0");
      if (qty > 0) {
        itemsToSubmit.push({
          name: `${loginInfo.empId} ${loginInfo.empName}`,
          category: selected.category,
          zcode: (selected.zcode || 'Z1'),
          subcategory: name,
          size: "ê°œ",
          quantity: qty,
          remarks
        });
      }
    });

    if (itemsToSubmit.length === 0) return alert("ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    document.getElementById('submitOverlay').style.display = 'flex';

    try {
      for (const item of itemsToSubmit) {
        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            name: item.name,
            category: item.category,
            zcode: item.zcode,
            subcategory: item.subcategory,
            size: item.size,
            quantity: item.quantity,
            remarks: item.remarks,
            ì§€ê¸‰ìˆ˜ëŸ‰: item.quantity,
            êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰: 0
          })
        });
      }
      alert("âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeZ1Modal();
    } catch (err) {
      alert("âŒ ì‹ ì²­ ì‹¤íŒ¨: " + err.message);
    } finally {
      document.getElementById('submitOverlay').style.display = 'none';
    }
  }

  // Z2 ìœ ë‹ˆí¼ ëª¨ë‹¬ â€” ìˆ˜ëŸ‰ ì œí•œ/ê²€ì¦ ì—†ìŒ
  function openZ2UniformModal() {
    const headerEl = document.getElementById('z2Header');
    const headerTxt = zMeta?.Z2?.header || 'ğŸ‘• ìœ ë‹ˆí¼ ì¼ê´„ ì‹ ì²­ (Z2)';
    if (headerEl) headerEl.innerText = headerTxt;

    const z2Notice = zMeta?.Z2?.notice || '';
    renderNoticeTo(document.getElementById('z2RuleText'), z2Notice);

    const wrap = document.getElementById("z2UniformContent");
    wrap.innerHTML = "";
    const stockMap = itemData[selected.category]?.stockMap || {};
    const byType = {};
    Object.keys(stockMap).forEach(k => {
      const [type, size] = k.split("__");
      if (!byType[type]) byType[type] = [];
      byType[type].push({ size, stock: stockMap[k] });
    });

    (Object.keys(byType)).forEach(type => {
      const sizes = byType[type].sort((a,b) => a.size.localeCompare(b.size, 'ko', {numeric:true}));
      const section = document.createElement("div");
      section.style.marginBottom = "16px";
      section.innerHTML = `<h4 style="text-align:left;margin:8px 0;">${type}</h4>`;
      const table = document.createElement("table"); table.style.width="100%"; table.style.borderCollapse="collapse";
      const thead = document.createElement("thead"); const tbody = document.createElement("tbody");
      thead.innerHTML = `
        <tr>
          <th style="border:1px solid #ddd;padding:6px;background:#f7f7f7;">ì‚¬ì´ì¦ˆ</th>
          <th style="border:1px solid #ddd;padding:6px;background:#f7f7f7;">ì¬ê³ </th>
          <th style="border:1px solid #ddd;padding:6px;background:#f7f7f7;">ì‹ ì²­ ìˆ˜ëŸ‰</th>
        </tr>`;
      sizes.forEach(({size, stock}) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td style="border:1px solid #ddd;padding:6px;text-align:center;">${size}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;">${stock}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;">
            <input type="number" min="0" value="0" data-z2-type="${type}" data-z2-size="${size}"
                   style="width:80px;text-align:center;border:1px solid #ccc;border-radius:6px;padding:4px;">
          </td>`;
        tbody.appendChild(row);
      });
      table.appendChild(thead); table.appendChild(tbody);
      section.appendChild(table); wrap.appendChild(section);
    });

    document.getElementById("modalZ2Uniform").style.display = "block";
  }
  function closeZ2UniformModal() { document.getElementById("modalZ2Uniform").style.display = "none"; }

  let isSubmittingZ2Uniform = false;

  async function submitZ2Uniform() {
    if (isSubmittingZ2Uniform) return;

    const inputs = document.querySelectorAll('#z2UniformContent input[type="number"][data-z2-type][data-z2-size]');
    const remarks = document.getElementById("z2UniformRemarks").value || "";
    const itemsToSubmit = [];

    inputs.forEach(inp => {
      const qty = parseInt(inp.value || "0", 10);
      if (qty > 0) {
        itemsToSubmit.push({
          name: `${loginInfo.empId} ${loginInfo.empName}`,
          category: selected.category,
          zcode: (selected.zcode || 'Z2'),
          subcategory: inp.dataset.z2Type,
          size: inp.dataset.z2Size,
          quantity: qty,
          remarks
        });
      }
    });

    if (itemsToSubmit.length === 0) return alert("ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const overlay = document.getElementById('submitOverlay');
    const overlaySpan = overlay.querySelector('span');
    const prevText = overlaySpan.textContent;
    overlaySpan.textContent = 'ğŸ‘• ì‹ ì²­ ì¤‘ì…ë‹ˆë‹¤..';
    overlay.style.display = 'flex';

    const submitBtn = document.getElementById('z2UniformSubmitBtn');
    if (submitBtn) submitBtn.disabled = true;
    isSubmittingZ2Uniform = true;

    try {
      for (const item of itemsToSubmit) {
        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            name: item.name,
            category: item.category,
            zcode: item.zcode,
            subcategory: item.subcategory,
            size: item.size,
            quantity: item.quantity,
            remarks: item.remarks,
            ì§€ê¸‰ìˆ˜ëŸ‰: item.quantity,
            êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰: 0
          })
        });
      }
      alert("âœ… ìœ ë‹ˆí¼ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeZ2UniformModal();
    } catch (err) {
      alert("âŒ ì‹ ì²­ ì‹¤íŒ¨: " + err.message);
    } finally {
      overlaySpan.textContent = prevText;
      overlay.style.display = 'none';
      if (submitBtn) submitBtn.disabled = false;
      isSubmittingZ2Uniform = false;
    }
  }
</script>

<!-- ì˜¤ë²„ë ˆì´ë“¤ -->
<div id="submitOverlay"><span>ğŸ“¤ ì‹ ì²­ ì¤‘ì…ë‹ˆë‹¤...</span></div>
<div id="loadingOverlay">â³ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</div>

<!-- Z1 ëª¨ë‹¬ -->
<div id="modalZ1" class="z-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
  <div style="background:white;margin:60px auto;padding:20px;border-radius:10px;max-width:600px;width:90%;position:relative;">
    <button onclick="closeZ1Modal()" style="position:absolute;top:10px;right:10px;font-size:22px;background:none;border:none;cursor:pointer;line-height:1;">âœ–</button>
    <h3 id="z1Header">ğŸ“… ì •ê¸° ì‹ ì²­ (Z1/Z3)</h3>
    <p id="z1RuleText" style="background:#fff3cd;padding:10px;border:1px solid #ffeeba;border-radius:6px;color:#856404;font-size:0.85rem;margin-bottom:10px;"></p>
    <div id="z1-item-list"></div>
    <textarea id="z1-remarks" placeholder="ê³µí†µ ë¹„ê³  ì…ë ¥ (ì„ íƒ)" rows="2" style="width:100%;margin-top:10px;"></textarea>
    <button onclick="submitZ1()" style="margin-top:10px;">âœ… ì‹ ì²­í•˜ê¸°</button>
  </div>
</div>

<!-- Z2 ìœ ë‹ˆí¼ ëª¨ë‹¬ -->
<div id="modalZ2Uniform" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
  <div style="background:white;margin:60px auto;padding:20px;border-radius:10px;max-width:800px;width:95%;max-height:80vh;overflow:auto;position:relative;">
    <button onclick="closeZ2UniformModal()" style="position:absolute;top:10px;right:10px;font-size:22px;background:none;border:none;cursor:pointer;line-height:1;">âœ–</button>
    <h3 id="z2Header">ğŸ‘• ìœ ë‹ˆí¼ ì¼ê´„ ì‹ ì²­ (Z2)</h3>
    <p id="z2RuleText" style="background:#fff3cd;padding:10px;border:1px solid #ffeeba;border-radius:6px;color:#856404;font-size:0.85rem;margin-bottom:10px;"></p>
    <div id="z2UniformContent"></div>
    <textarea id="z2UniformRemarks" placeholder="ê³µí†µ ë¹„ê³  (ì„ íƒ)" rows="2" style="width:100%;margin-top:10px;"></textarea>
    <button id="z2UniformSubmitBtn" onclick="submitZ2Uniform()" style="margin-top:10px;">âœ… ì‹ ì²­í•˜ê¸°</button>
  </div>
</div>

</body>
</html>
